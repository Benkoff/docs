# Keepers

Микросервис занимается обработкой информации о Хранителях, специальном типе пользователей курса. 

Данные хранятся в базе MongoDB. Микросервис предоставляет пользователям (другим сервисам) RESTful API


## Технические характеристики:

* JDK8
* Mongo
* SpringBoot
* SpringData
* jUnit
* FakeMongo 

## Общие положения

* **KPR-D1** Хранитель - особенный тип пользователей, которые занимаются активной поддержкой и развитием определенных направлений на курсе.
* **KPR-D2** Первый пользователь в системе является Хранителем. Заявка при этом добавляется вручную.
* **KPR-D3** Этот тип пользователей (Хранители) могут совершать определенные дополнительные действия. 
* **KPR-D4** Эту конкретную операцию может совершать только ограниченный набор людей, уже отмеченных как активные Хранители. В случае, если в поле “from” указан не такой пользователь - возникает ошибка формате KPR-D11 с текстом “Только Хранитель может назначить другого Хранителя”.
* **KPR-D5** Эту конкретную операцию может выполнять только Система.
* **KPR-D6** Изначально Хранитель помечается активным.
* **KPR-D7** Хранитель может стать со временем не активным - это значит, что он сейчас имеет права простого пользователя, но это не значит, что информация о его заявке будет удалена из системы - просто в заявке делается пометка об окончании срока его хранительствования.
* **KPR-D8** Хранитель может быть связан с несколькими направлениями, для каждого такого направления делается отдельная заявка. При этом Хранителем, в контексте данного микросервиса, считается не конкретный пользователь, а эта самая заявка, которая связывает UID пользователя с описанием направления Хранительствования, за которое он отвечает.
* **KPR-D9** За каждое активное направление Хранитель в качестве благодарности получает 2 джуджика раз в неделю. 
* **KPR-D9-1** Для выдачи ачивки за хранительство отправляется соответствующий запрос на сервис Геймификации.
* **KPR-D9-2** Текст благодарности хранится в отдельном поле (description) и передается в теле запроса.
* **KPR-D9-3** Текст благодарности обязательно содержит ключевое слово, определяющее направление Хранительствования, например 'JuJaMap’, ‘Codenjoy’
* **KPR-D10** В случае успешно выполненной операции для void методов юзер получает ответ 200 OK. “void метод” - это endpoint который не подразумевает возврата результата. Смотри детальнее [тут](https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D0%BA%D0%BE%D0%B4%D0%BE%D0%B2_%D1%81%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D1%8F_HTTP#200).
* **KPR-D11** В случае ошибки на выход возвращается json в формате {“errorCode”:”N”, “message”:”сообщение”}, где errorCode код описания еррор-фичи в этой доке, например “KPR-F1-D5”.

## Список фичей

**KPR-F1 Я, как Хранитель, хочу добавить в систему нового Хранителя и сделать его активным**

* KPR-F1-D1 Указывается UID Хранителя, который запоминается в системе.
* KPR-F1-D2 Указывается дескрипшен с текстом благодарности, который запоминается в системе. 
* KPR-F1-D3 В системе сохраняется дата выполнения запроса - с тем, чтобы отметить начало его пути.
* KPR-F1-D4 При этом ачивка ему не выдаётся сейчас - для этого есть другой метод KPR-F3.
* KPR-F1-D5 Операцию могут выполнять не все пользователи. Смотри KPR-D4.

* KPR-F1-URL
  ```
      url - "/keepers/add"
      method - POST
  ```
* KPR-F1-REQ
   ```
      {
          “from” : “...”,
          “keeper” : “...”,
          “description” : “...”
      }
   ```
* KPR-F1-RSP согласно **KPR-D10**
* KPR-F1-S1-REQ  ``/keeper-add @slack_nick_name Хранитель Блаблаблафикации``
* KPR-F1-S2-RSP Спасибо мы добавили нового Хранителя @slack_nick_name
* KPR-F1-S3-RSP Текст ошибки. Формат команды “текст из KPR-F1-S1-REQ”. Первым параметром является слак ник будущего Хранителя, после чего (разделенный пробелом) указывается текст благодарности при выдаче ачивки. Текст должен содержать ключевое слово определяющее направление Хранительствования.

**KPR-F2 Я, как Хранитель, хочу сделать существующего Хранителя неактивным**

* KPR-F2-D1 Указывается UID Хранителя, которого нужно сделать неактивным.
* KPR-F2-D2 Так как один и тот же пользователь может быть Хранителем в разных направлениях, то при выполнении этого запроса необходимо указать не только UID пользователя, но и ключевое слово-фильр из description ранее сохраненного в заявке. Делается это через поле “filter” KPR-F2-REQ-1.
* KPR-F2-D3 В случае, если это поле не указано (KPR-F2-REQ-2), то делается выборка по всем активным заявкам этого пользователя.
* KPR-F2-D4 Если заявок более чем 1, то  возникает ошибка формате KPR-D11 с текстом “Этот Пользователь является Хранителем нескольких направлений, уточните в поле ‘filter’ запроса, какую заявку приостановить? [‘JuJaMap’, ‘Codenjoy’]”.
* KPR-F2-D5 В системе сохраняется дата выполнения запроса - с тем, чтобы отметить окончание Хранительствования.
* KPR-F2-D6 Операцию могут выполнять не все пользователи. Смотри KPR-D4.

* KPR-F2-URL
  ```
      url - "/keepers/suspend"
      method - PUT
  ```
* KPR-F2-REQ-1
   ```
      {
          “from” : “...”,
          “keeper” : “...”,
          “filter” : “...”
      }
   ```
* KPR-F2-REQ-2
   ```
    {
        “from” : “...”,
        “keeper” : “...”
    }
   ```
* KPR-F2-RSP согласно **KPR-D10**

* KPR-F2-S1-REQ ``/keeper-suspend @slack_nick_name``.
* KPR-F2-S2-RSP Хранитель @slack_nick_name приостановлен.
* KPR-F2-S3-RSP Текст ошибки. Формат команды “текст из KPR-F2-S1-REQ”. Параметром является слак ник активного Хранителя.


**KPR-F3 Я, как Система, хочу выдать всем активным Хранителям благодарность в виде джуджиков**

* KPR-F3-D1 Отправляется запрос на сервис [Gamification](https://github.com/JujaLabs/gamification) для присвоения ачивок за Хранительство.
* KPR-F3-D2 Текст сообщения к ачивке берется из записи description сохраненной ранее в KPR-F1.
* KPR-F3-D3 Активный Хранитель, значит тот, который был добавлен ранее через KPR-F1 и не деактивирован по прошествии определенного времени через KPR-D2.
* KPR-F3-D4 Операцию может выполнять только Система по заданному интервалу (Cron scheduler, etc). Смотри KPR-D5.

* KPR-F3-URL
```
    url - "/keepers/thanks"
    method - POST
```

* KPR-F3-REQ
    ```
    {}
    ```
* KPR-F3-RSP согласно **KPR-D10**.